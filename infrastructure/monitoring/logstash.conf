input {
  tcp {
    port => 5000
    codec => json
    type => "microservices"
  }
  udp {
    port => 5000
    codec => json
    type => "microservices"
  }
}

filter {
  if [type] == "microservices" {
    mutate {
      add_field => { "[@metadata][index_name]" => "logs-%{+YYYY.MM.dd}" }
    }

    # Parse timestamps
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }

    # Extract log level
    if [message] =~ /ERROR|Error|error/ {
      mutate { add_field => { "log_level" => "ERROR" } }
    } else if [message] =~ /WARN|Warn|warn/ {
      mutate { add_field => { "log_level" => "WARN" } }
    } else if [message] =~ /DEBUG|Debug|debug/ {
      mutate { add_field => { "log_level" => "DEBUG" } }
    } else {
      mutate { add_field => { "log_level" => "INFO" } }
    }

    # Extract service name if available
    if [service] {
      mutate { add_field => { "service_name" => "%{service}" } }
    }

    # Extract request info
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      tag_on_failure => [ "_grok_parse_failure" ]
      overwrite => [ "message" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_name]}"
    user => "elastic"
    password => "changeme"
  }

  # Also send to stdout for debugging
  stdout {
    codec => rubydebug
  }
}
